<link rel="import" href="../d2l-fastdom-import/fastdom.html">

<script>
	window.D2L = window.D2L || {};
	window.D2L.PolymerBehaviors = window.D2L.PolymerBehaviors || {};
	window.D2L.PolymerBehaviors.Date = window.D2L.PolymerBehaviors.Date || {};

	/** @polymerBehavior D2L.PolymerBehaviors.Date.InputDateBehavior */
	D2L.PolymerBehaviors.Date.InputDateBehaviorImpl = {
		properties: {
			_target: {
				type: Object
			},
			_descriptionId: {
				type: String
			},
			/**
			 * The placeholder text for when the date is empty.
			 */
			placeholder: {
				type: String
			},
			/**
			 * The minimum date allowed the user can choose.
			 */
			min: {
				type: String
			},
			/**
			 * The maximum date allowed the user can choose.
			 */
			max: {
				type: String
			},
			/**
			 * The label for the input field.
			 */
			label: {
				type: String
			},
			hideLabel: {
				type: Boolean,
				value: false,
				reflectToAttribute: true
			},
			description:{
				type: String
			},
			/**
			 * The locale for the picker, for example, 'en', 'fr'...
			 */
			locale: {
				type: String,
				value: 'en'
			},
			/**
			 * The first day of the week for the date picker
			 * (0 = Sunday, 1 = Monday, 2 = Tuesday, 3 = Wednesday, 4 = Thursday, 5 = Friday, 6 = Saturday)
			 */
			firstDayOfWeek: {
				type: Number,
				value: 0
			},
			/**
			 * The 'value' attribute sets the current date of the picker in an ISO format (YYYY-MM-DD)
			 */
			value: {
				type: String,
				reflectToAttribute: true,
				notify: true
			},
			/**
			 * Allows the user to provide the `--vaadin-date-picker-overlay` mixin when set to true.
			 */
			customOverlayStyle: {
				type: Boolean,
				reflectToAttribute: true,
				value: false
			}
		},

		observers: [
			'_updateInputDatei18n( locale, localize, firstDayOfWeek )'
		],

		ready: function() {
			this._descriptionId = D2L.Id.getUniqueId();
			this._handleValueChanged = this._handleValueChanged.bind(this);

			if (this._isPolymer2()) {
				this._setUpChangeEventListenerPolymer2();
			}
		},

		attached: function() {
			var buttons = document.getElementsByClassName('vaadin-date-picker-overlay paper-button-0');

			fastdom.mutate(function() {
				for (var i = 0; i < buttons.length; i++) {
					buttons[i].style.fontFamily = 'inherit';
				}
			});
		},

		detached: function() {
			if (this._isPolymer2()) {
				this.removeEventListener('value-changed', this._handleValueChanged);
			}
			this._changeListener = null;
		},

		_setUpChangeEventListenerPolymer2: function() {
			// on-value-changed got removed for the Polymer2 version of vaadin-date-picker,
			// so for Polymer2 we'll set our own event
			this.addEventListener('value-changed', this._handleValueChanged);
		},

		_isPolymer2: function() {
			return !!Polymer.Element;
		},

		_handleValueChangedPolymer1: function(e) {
			// using the `value-changed` listener sometimes sends 2 events in the
			// Polymer 1 vaadin-date-picker when in shadyDom, so this function listens to
			// on-value-changed from the vaadin-date-picker (removed in Polymer 2)
			if (this._isPolymer2()) {
				return;
			}
			this._handleValueChanged(e);
		},

		_handleValueChanged: function(e) {
			this.dispatchEvent(new CustomEvent('d2l-input-date-changed', {
				detail: e.detail,
				bubbles: true
			}));
		},

		_handleTap: function() {
			var inputDate = this.$$('vaadin-date-picker-light');
			if (!inputDate.opened) {
				inputDate._focusOverlayOnOpen = true;
			}
		},

		onEnter: function(e) {
			var inputDate = this.$$('vaadin-date-picker-light');
			if (!inputDate.opened) {
				// A better solution is to add a boolean to the 3rd party open function
				inputDate._focusOverlayOnOpen = true;
				inputDate.open();
				e.detail.keyboardEvent.preventDefault();
				e.detail.keyboardEvent.stopPropagation();
			}

		},

		onUpDown: function(e) {
			var inputDate = this.$$('vaadin-date-picker-light');
			if (!inputDate.opened) {
				e.detail.keyboardEvent.preventDefault();
				e.detail.keyboardEvent.stopPropagation();
			}
		},

		_handleFocus: function() {
			// in shady DOM the input's "focus" event does not bubble,
			// so no need to fire it
			if (!Polymer.Settings.useShadow) {
				this.dispatchEvent(new CustomEvent(
					'focus',
					{ bubbles: true, composed: false }
				));
			}
		},

		_updateInputDatei18n: function() {
			var locale = d2lIntl.LocaleProvider(this.locale);

			var inputDate = this.$$('vaadin-date-picker-light');
			var localeOverrides = {
				monthNames: locale.date.calendar.months.long,
				weekdays: locale.date.calendar.days.long,
				weekdaysShort: locale.date.calendar.days.short,
				firstDayOfWeek: this.firstDayOfWeek ? this.firstDayOfWeek : locale.date.calendar.firstDayOfWeek,
				today: this.localize('today'),
				cancel: this.localize('cancel'),
				formatDate: function(date) {
					return this.formatDate(date);
				}.bind(this),
				parseDate: function(dateString) {
					try {
						return this.parseDate(dateString);
					} catch (exception) {
						return null;
					}
				}.bind(this)
			};
			var inputDateLocale = this._merge(inputDate.i18n, localeOverrides);
			inputDate.i18n = {}; // reassign to have Polymer refresh
			inputDate.i18n = inputDateLocale;
		},

		_merge: function(obj1, obj2) {
			if (obj2 === undefined || obj2 === null || typeof(obj2) !== 'object') {
				return obj1;
			}
			Object.keys(obj2).forEach(function(i) {
				if (obj1.hasOwnProperty(i)) {
					if (typeof(obj2[i]) === 'object' && typeof(obj1[i]) === 'object') {
						this._merge(obj1[i], obj2[i]);
					} else {
						obj1[i] = obj2[i];
					}
				}
			}.bind(this));
			return obj1;
		}
	};

	/** @polymerBehavior D2L.PolymerBehaviors.Date.InputDateBehavior */
	D2L.PolymerBehaviors.Date.InputDateBehavior = [
		D2L.PolymerBehaviors.Date.InputDateBehaviorImpl
	];
</script>
